#!/bin/sh

export LD_LIBRARY_PATH="/usr/lib64/apulse"

if command -v spotify-dbus.py > /dev/null; then
        echo "Launching spotify with Gnome systray integration."
        spotify-dbus.py "$@"
elif [ -e "/opt/spotify/spotify-client/spotify-tray" ] > /dev/null; then
        echo "Launching spotify with generic systray integration."
        minimized=
        for arg; do
                if [ "$arg" = --minimized ]; then
                        minimized=$arg
                        break
                fi
        done
        GDK_BACKEND="x11" "/opt/spotify/spotify-client/spotify-tray" \
                --client-path="/opt/spotify/spotify-client/spotify" --toggle $minimized -- "$@"
else
    if pgrep -f "Spotify/[0-9].[0-9].[0-9]" > /dev/null; then
        busline="org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.mpris.MediaPlayer2.Player.OpenUri ${1}"
        echo "Spotify is already running"
        echo "Sending ${busline} to dbus"
        if command -v qdbus &> /dev/null; then
            qdbus $busline
            exit
        fi
        if command -v dbus-send &> /dev/null; then
            dbus-send $busline
            exit
        fi
        echo "No bus dispatcher found."
    else
        echo "Neither gnome-integration-spotify nor spotify-tray are installed."
        echo "Launching spotify without systray integration."
        exec "/opt/spotify/spotify-client/spotify" "$@" &
    fi
fi

# Spotify creates the $HOME/Downloads directory for no reason.
# Given that I use $HOME/downloads instead, let's delete it.
sleep .05 && rmdir -v "$HOME/Downloads"

