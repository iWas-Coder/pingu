#!/usr/bin/env bash

arg_usage () { echo -ne "  $1 \t=> $2.\n"; }

usage () {
  echo "Usage:"
  arg_usage "-h/--help" "Show this help panel and exit"
  arg_usage "-a/--archive" "Compress game with ZPAQ and store it in the vault"
  arg_usage "-i/--install" "Fetch the game archival from the vault and decompress it locally"
  echo
}

is_mounted () { mountpoint -q "$1"; }


trap "echo; exit" INT

if [ $# -ne 2 ]; then
  usage; exit 1
elif [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  usage; exit 0
elif ! is_mounted /home/iwas/vault; then
  echo "Vault is not mounted :("; exit 2
fi

cd /home/iwas

MODE="$1"
GAME="$2"
GAMES="/usr/local/games"
LOGFILE="/home/iwas/.game-pkg.log"
MOUNTPOINT="/home/iwas/vault"
ARCHIVE_DIR="$MOUNTPOINT/games-lrz"
LRZTAR="lrztar -vv -z -p 10 -H"
LRZUNTAR="lrztar -vv -z -p 10 -H -d"
RSYNC_MV="rsync -aP --remove-source-files"
RSYNC_CP="rsync -aP"

for game in $(ls "$GAMES"); do
  if [ "$game" = "$GAME" ]; then
    # === Archive mode === #
    if [ "$MODE" = "-a" ] || [ "$MODE" = "--archive" ]; then
      # Compute game paths
      GAME_DIR=$(dirname "$(realpath "$GAMES/$GAME")")
      PARENT_GAME_DIR=$(dirname "$GAME_DIR")
      NAME_GAME_DIR=$(basename "$GAME_DIR")
      pushd "$PARENT_GAME_DIR" &>/dev/null
      # Compress
      $LRZTAR "$NAME_GAME_DIR"
      # Transfer to vault
      $RSYNC_MV "$NAME_GAME_DIR".tar.lrz "$ARCHIVE_DIR"
      # Delete game (local copy)
      rm -rvf "$GAME_DIR" \
        || echo "[-] Failed to delete completely the dir '$GAME_DIR'."
      # Tag game as archived (write line from logfile)
      echo "$GAME $GAME_DIR" >> "$LOGFILE"
      popd &>/dev/null
    # === Extract mode === #
    elif [ "$MODE" = "-i" ] || [ "$MODE" = "--install" ]; then
      # Compute game paths (with logfile)
      GAME_DIR=$(cat "$LOGFILE" | grep "$GAME" | awk '{print $2}')
      PARENT_GAME_DIR=$(dirname "$GAME_DIR")
      NAME_GAME_DIR=$(basename "$GAME_DIR") 
      pushd "$PARENT_GAME_DIR" &>/dev/null
      # Copy from vault
      $RSYNC_CP "$ARCHIVE_DIR"/"$NAME_GAME_DIR".tar.lrz .
      # Decompress (local copy)
      $LRZUNTAR "$NAME_GAME_DIR".tar.lrz
      # Delete archive (local copy)
      rm -vf "$NAME_GAME_DIR".tar.lrz
      # Tag game as installed (delete line from logfile)
      sed -i "/$GAME/d" "$LOGFILE"
      popd &>/dev/null
    else
      usage; exit 1
    fi
  fi
done
